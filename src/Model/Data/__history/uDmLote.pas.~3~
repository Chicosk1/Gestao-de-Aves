unit uDmLote;

interface

uses
  System.SysUtils,
  Data.DB,
  FireDAC.Comp.Client,
  uDmInterface,
  dmConexao;

type
  TDmLote = class(TInterfacedObject, ILoteDAO)
  private
    FStoredProc: TFDStoredProc;
  public
    constructor Create;
    destructor Destroy; override;
    class function New: ILoteDAO;
    function ObterTodos: TDataSet;
  end;

implementation

{ TDmLote }

constructor TDmLote.Create;
begin
  FStoredProc := TFDStoredProc.Create(nil);
  FStoredProc.Connection := DataModuleConexao.GetConexao;
end;

destructor TDmLote.Destroy;
begin
  // 3. Limpa a memória ao destruir a classe
  FStoredProc.Free;
  inherited;
end;

class function TDmLote.New: ILoteDAO;
begin
  Result := Self.Create;
end;

function TDmLote.ObterTodos: TDataSet;
begin
  // Se a consulta já estiver aberta, fecha para atualizar
  if FStoredProc.Active then
    FStoredProc.Close;

  // 4. Configura o nome da Procedure que criamos no Banco
  FStoredProc.StoredProcName := 'SP_GET_LOTES';

  // 5. Prepara os metadados (boa prática)
  FStoredProc.Prepare;

  // 6. Executa.
  // IMPORTANTE: Usamos .Open (e não ExecProc) porque essa procedure retorna dados (ROWS)
  FStoredProc.Open;

  Result := FStoredProc;
end;

end.
